"use strict";function guid(a){var b,c="";for(a=a||32,b=0;a>b;b++)c+=(0|36*Math.random()).toString(36);return console.log("uid="+c),c}function offset(a){for(var b=0,c=0;a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return[b,c]}function regex(a){try{return new RegExp("(\\s+|^)"+a.replace(/\W/g,function(a){return"\\"+a})+"(\\s+|$)","g")}catch(b){return null}}function hasClass(a,b){return regex(b).test(a.className)}function removeClass(a,b){a.className=a.className.replace(regex(b)," ")}function addClass(a,b){removeClass(a,b),a.className=a.className+" "+b}function prettyDate(a,b){var c=new Date(parseInt(a,10)),d=new Date(b),e=(d.getTime()-c.getTime())/864e5,f=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],g=["January","February","March","April","May","June","July","August","September","October","November","December"],h="";return e>6?(h+=g[c.getMonth()]+" "+c.getDate(),h=(c.getFullYear()!==d.getFullYear()?c.getFullYear()+" ":"")+h):h=h||e>1?f[c.getDay()]:c.getDay()!=d.getDay()?"yesterday":"",h+" at "+c.getHours()+":"+(c.getMinutes()<10?"0":"")+c.getMinutes()}function addEvent(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&(a["e"+b+c]=c,a[b+c]=function(){return a["e"+b+c](addEvent.fixEvent(window.event))},a.attachEvent("on"+b,a[b+c]))}function removeEvent(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&(a.detachEvent("on"+b,a[b+c]),a[b+c]=null,a["e"+b+c]=null)}function get(a,b){request("GET",a,b)}function post(a,b,c){request("POST",a,c,b)}function getx(a,b){var c,d=document.createElement("script"),e="c";for(c=0;6>c;c++)e+=Math.floor(256*Math.random()).toString(16);window[e]=function(a){try{delete window[e]}catch(c){window[e]=null}try{a=JSON.parse(a),b(null,a)}catch(c){b(null,a)}},a=a+(-1==a.indexOf("?")?"?":"&")+"callback="+e,document.body.appendChild(d),d.src=a,addEvent(d,"load",function(){document.body.removeChild(d)})}function request(a,b,c,d){var e=createXMLHTTPObject();return e?(e.open(a,b,!0),d&&(e.setRequestHeader("Content-type","application/json"),"object"==typeof d&&(d=JSON.stringify(d))),e.onreadystatechange=function(){var a;if(4==e.readyState){if(200!=e.status&&304!=e.status)return c("http-"+e.status),void 0;try{a=JSON.parse(e.responseText)}catch(b){return a=e.responseText,void 0}c(null,a)}},4!=e.readyState&&e.send(d),void 0):(setTimeout(function(){c("no-xmlhttp-object")},0),void 0)}function createXMLHTTPObject(){for(var a=!1,b=0;b<XMLHttpFactories.length;b++){try{a=XMLHttpFactories[b]()}catch(c){continue}break}return a}function messageArray(a){function b(a,c,d){var f;return"undefined"==typeof c?b(a,0,e.length):a?c>=d?c:(f=0|(c+d)/2,e[f]&&e[f].time<a?b(a,f+1,d):e[f-1]&&e[f-1].time>=a?b(a,c,f-1):f):d}function c(a){if(a.length){for(var c=a[0].time,d=a[a.length-1].time,f=b(c),g=b(d);e[f-1]&&e[f-1].time==c;)f--;for(;e[g]&&e[g].time==d;)g++;e[f-1]&&"result-end"!=e[f-1].type&&"result-start"==a[0].type&&a.shift(),e[g]&&"result-start"!=e[g].type&&"result-end"==a[a.length-1].type&&a.pop(),[].splice.apply(e,[f,g-f].concat(a))}}function d(a,c,d,f){var g,h,i,j,k=[],l=e.length,m=null;for(!a&&f&&(k.push(f(null,null)),a=1e13),g=b(a),h=g,i=0;h>0&&c>i;h--)e[h]&&"text"==e[h].type&&i++;for(i=0;l>h&&c+d+1>i;h++)switch(j=e[h],j.type){case"result-start":f&&k.push(f(m,j.time));break;case"result-end":m=j.time;break;case"text":k.push(j),i++}return j&&"result-end"==j.type&&f&&k.push(f(j.time,null)),k}var e=a||[];return e.merge=c,e.find=b,e.extract=d,e}function sanitizeRoomName(a){return a=a.trim(),a=a.replace(/[^a-zA-Z0-9]/g,"-").replace(/^-+|-+$/,""),a.length<3&&(a+=Array(3-a.length+1).join("-")),a}function onInit(a){nick=a.user.id,core.membership=a.user.membership,core.emit("membership",a.user.membership),core.emit("nick",nick),a.serverTime&&a.clientTime&&(core.emit("connected"),timeAdjustment=a.serverTime-a.clientTime,scrollback.debug&&console.log(a),scrollback.streams&&scrollback.streams.length&&scrollback.streams.forEach(function(a){a&&core.enter(a)}))}function send(a,b,c,d,e){var f,g={id:guid(),type:a,from:nick,to:b,text:c||"",time:core.time()};if(g.origin={gateway:"web",location:window.location.toString()},d)for(f in d)d.hasOwnProperty(f)&&(g[f]=d[f]);return"result-start"!=g.type&&"result-end"!=g.type&&1==socket.readyState&&socket.emit("message",g),"undefined"!=typeof messageArray&&rooms[b]&&(rooms[b].messages.push(g),f=rooms[b].messages.length-1,requests[b+"//"]&&requests[b+"//"](!0)),pendingCallbacks[g.id]=function(a){a.message&&"undefined"!=typeof messageArray&&rooms[b]&&(rooms[b].messages.splice(f,1),requests[b+"//"]&&requests[b+"//"](!0)),e&&e(a)},setTimeout(function(){pendingCallbacks[g.id]&&delete pendingCallbacks[g.id]},1e4),g}function onMessages(a){var b=a.query.to,c=a.query.to+"/"+(a.query.since||"")+"/"+(a.query.until||"");rooms[b].messages.merge(a.messages),requests[c]&&(requests[c](!0),c!=a.query.to+"//"&&delete requests[c])}function onMessage(a){var b,c,d=!1;if(scrollback.debug&&console.log("Received:",a),core.emit("message",a),"nick"==a.type&&a.from==core.nick()&&core.nick(a.ref),pendingCallbacks[a.id]&&(pendingCallbacks[a.id](a),delete pendingCallbacks[a.id]),c=rooms[a.to]&&rooms[a.to].messages){for(b=c.length-1;b>=0&&a.time-c[b].time<12e4;b--)if(c[b].id==a.id){scrollback.debug&&console.log("Time adjustment is now "+timeAdjustment),c[b]=a,d=!0;break}d||c.push(a),requests[a.to+"//"]&&requests[a.to+"//"](!0)}}function onError(a){a.id&&pendingCallbacks[a.id]&&(pendingCallbacks[a.id](a),delete pendingCallbacks[a.id]),core.emit("error",a.message)}Object.keys||(Object.keys=function(a){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError("Object.keys called on non-object");var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push(b);return c}),"function"!=typeof Object.create&&(Object.create=function(a){function b(){}return b.prototype=a,new b}),Array.prototype.remove||(Array.prototype.remove=function(a){var b=this.indexOf(a);return-1!==b?this.splice(b,1):void 0}),Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){for(var c=0,d=this.length;d>c;++c)a.call(b,this[c],c,this)}),Array.prototype.map||(Array.prototype.map=function(a,b){for(var c=[],d=0,e=this.length;e>d;++d)c.push(a.call(b,this[d],d,this));return c}),window.console||(window.console={log:function(){}}),addEvent.fixEvent=function(a){return a.preventDefault=addEvent.preventDefault,a.stopPropagation=addEvent.stopPropagation,a},addEvent.preventDefault=function(){this.returnValue=!1},addEvent.stopPropagation=function(){this.cancelBubble=!0};var emitter={handlers:{},emit:function(a,b){this.handlers.hasOwnProperty(a)&&this.handlers[a].forEach(function(a){setTimeout(function(){a(b)},0)})},on:function(a,b){this.handlers.hasOwnProperty(a)?this.handlers[a].push(b):this.handlers[a]=[b]},off:function(a,b){this.handlers.hasOwnProperty(a)&&this.handlers.remove(b)}},XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],socket=new SockJS(scrollback.host+"/socket"),timeAdjustment=0,rooms={},requests={},lastPos,core=Object.create(emitter),nick="",user,pendingCallbacks={};window.scrollback.streams&&(window.scrollback.streams=window.scrollback.streams.map(function(a){return sanitizeRoomName(a)})),window.scrollback.nick&&(window.scrollback.nick=sanitizeRoomName(window.scrollback.nick)),socket.emit=function(a,b){scrollback.debug&&console.log("Socket sending ",a,b),socket.send(JSON.stringify({type:a,data:b}))},socket.onopen=function(){function a(a){var b={sid:a,clientTime:(new Date).getTime()};scrollback.nick&&(b.nick=scrollback.nick),socket.emit("init",b)}getx(scrollback.host+"/dlg/cookie",function(b,c){b||a(c)})},socket.onerror=function(a){scrollback.debug&&console.log(a)},socket.onclose=function(){var a;for(a in rooms)rooms.hasOwnProperty(a)&&core.leave(a);core.emit("disconnected")},socket.onmessage=function(a){var b;try{b=JSON.parse(a.data)}catch(c){return scrollback.debug&&console.log("ERROR: Non-JSON data",a.data),void 0}switch(scrollback.debug&&console.log("Socket received",b),b.type){case"init":onInit(b.data);break;case"message":onMessage(b.data);break;case"messages":onMessages(b.data);break;case"error":onError(b.data)}},core.cache=function(a){return rooms[a].messages},core.time=function(){return(new Date).getTime()+timeAdjustment},core.enter=function(a){rooms[a]||(rooms[a]={messages:messageArray()}),send("result-start",a),send("back",a),core.emit("enter",a)},core.leave=function(a){send("away",a),send("result-end",a),core.emit("leave",a)},core.get=function(a,b,c,d){var e,f={to:a,type:"text"};b&&(f.since=b),c&&(f.until=c),e=a+"/"+(f.since||"")+"/"+(f.until||""),scrollback.debug&&console.log("Request:",e),requests[e]=d,socket.emit("messages",f)},core.say=function(a,b,c){send("text",a,b,{},c)},core.join=function(a,b){send(a,b)},core.nick=function(a,b){return a?("string"==typeof a&&(a={ref:a}),b?(send("nick","","",a,function(a){return a.ref&&(nick=a.ref,core.emit("nick",nick)),b?b(a):void 0}),void 0):(nick=a.ref,core.emit("nick",nick),a)):nick},core.watch=function(a,b,c,d,e){function f(b,c){return core.get(a,b,c,g),{type:"missing",text:"Loading messages...",time:b}}function g(g){var h=rooms[a].messages.extract(b,c||32,d||0,g?null:f);e(h)}b||(requests[a+"//"]=g),g(!1)},core.unwatch=function(a){delete requests[a+"//"]},core.update=function(a,b){scrollback.debug&&console.log("sending update"),socket.emit("update",{type:a,params:b})};
